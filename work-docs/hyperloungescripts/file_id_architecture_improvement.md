# file_id ìƒì„± ë°©ì‹ ê°œì„ ì•ˆ

## ë°°ê²½

2026-02-03 ì—˜ì•¤ì¼€ì´ì›°ë‹ˆìŠ¤(c8cd3500) board ì†ŒìŠ¤ì—ì„œ `fileid-mapping-board` íƒœìŠ¤í¬ ì‹¤íŒ¨.
collect-manager APIê°€ file_id ë§¤í•‘ 12ë§Œ ê±´ì„ í•œ ë²ˆì— ë°˜í™˜í•˜ë‹¤ê°€ ì‘ë‹µ í¬ê¸° ì´ˆê³¼ë¡œ 500 ì—ëŸ¬ ë°œìƒ.

## í˜„ì¬ êµ¬ì¡°

### file_id ìƒì„± íë¦„

```
1. Firestoreì—ì„œ ì „ì²´ file_id ë§¤í•‘ ë¡œë“œ (12ë§Œê±´)
   GET /file_id/{customer}/{source} â†’ ì „ì²´ ë°˜í™˜

2. ìƒˆ íŒŒì¼ë§ˆë‹¤ ë§¤í•‘ì„ forë¬¸ìœ¼ë¡œ ìˆœíšŒ
   â†’ ê°™ì€ file_nameì´ ìˆìœ¼ë©´: ê¸°ì¡´ file_id ì¬ì‚¬ìš©
   â†’ ì—†ìœ¼ë©´: UUIDë¡œ ìƒˆ file_id ìƒì„±

3. GCSì— íŒŒì¼ ë³µì‚¬ (file_name â†’ file_idë¡œ rename)

4. Firestoreì— ìƒˆ file_idë§Œ INSERT

5. BigQuery crawl_job_historyì— ê¸°ë¡
```

### file_id ìƒì„± ë°©ì‹ (í˜„ì¬: UUID)

```python
# collector/common/util.py
def generate_id12(prefix):
    uuid = str(uuid4())
    return re.sub("-", "", prefix + uuid[:12])

# ê²°ê³¼ ì˜ˆì‹œ: f1a2b3c4d5e6
# í¬ë§·: f(1ì) + ëœë¤ë¬¸ì(11ì) = ì´ 12ì
```

- ë§¤ë²ˆ ì™„ì „ ëœë¤ ê°’ ìƒì„±
- ê°™ì€ file_nameìœ¼ë¡œ 2ë²ˆ ì‹¤í–‰í•˜ë©´ ë‹¤ë¥¸ file_idê°€ ë‚˜ì˜´
- ê·¸ë˜ì„œ "ì´ì „ì— ì´ file_nameìœ¼ë¡œ ë§Œë“  file_idê°€ ìˆë‚˜?" í™•ì¸ì´ í•„ìˆ˜
- ì´ í™•ì¸ì„ ìœ„í•´ ì „ì²´ ë§¤í•‘ì„ Firestoreì—ì„œ ê°€ì ¸ì˜´

### ì™œ 12ë§Œê±´ì´ ìŒ“ì˜€ë‚˜

- file_nameì— ìˆ˜ì§‘ ë‚ ì§œê°€ í¬í•¨ë¨: `ë§¤ì¶œë³´ê³ ì„œ_20260203.xlsx`
- ë§¤ì¼ ë‚ ì§œê°€ ë°”ë€Œë¯€ë¡œ ë§¤ë²ˆ ìƒˆë¡œìš´ file_name â†’ ìƒˆ file_id ìƒì„±
- ë§¤ì¼ ~600ê±´ì”© 6ê°œì›” ëˆ„ì  â†’ 12ë§Œê±´

### ì‹¤ì œë¡œ ê¸°ì¡´ file_idê°€ ì¬ì‚¬ìš©ë˜ëŠ” ê²½ìš°

- **ê°™ì€ ë‚  retryí•  ë•Œë§Œ** (ê°™ì€ ë‚ ì§œ â†’ ê°™ì€ file_name â†’ ê¸°ì¡´ file_id ì¬ì‚¬ìš©)
- ì¦‰, 12ë§Œê±´ ì¡°íšŒëŠ” retry ëŒ€ë¹„ìš©ì¸ë° retryëŠ” ë“œë¬¼ê²Œ ë°œìƒ

### ì½”ë“œ í˜¸ì¶œ ì²´ì¸ (DAG â†’ file_renamer)

Airflow DAGì—ì„œ file_renamerê¹Œì§€ì˜ ì „ì²´ í˜¸ì¶œ íë¦„:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. DAG íŒŒì¼ (c8cd3500.py:150)                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ fileid_mapping_task = TaskFactory.create_fileid_mapping_task(CONFIG,     â”‚
â”‚                                                              source)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. TaskFactory (task_factory.py:124-132)                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ @staticmethod                                                            â”‚
â”‚ def create_fileid_mapping_task(dag_config, source_type):                 â”‚
â”‚     return PythonOperator(                                               â”‚
â”‚         task_id=f"fileid-mapping-{source_type}",                         â”‚
â”‚         python_callable=TaskFunctions.crawl_rename_files,  â—€â”€â”€ ì—¬ê¸°      â”‚
â”‚         params={**dag_config, 'source_type': source_type}                â”‚
â”‚     )                                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. TaskFunctions (task_functions.py:425-449)                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ def crawl_rename_files(params, **context):                               â”‚
â”‚     customer_code = params['customer_code']                              â”‚
â”‚     source_type = params['source_type']                                  â”‚
â”‚     api_svr_url = params['api_svr_url']                                  â”‚
â”‚     ...                                                                  â”‚
â”‚     run_rename_cloud_files(ingestion_id, customer_code, source_type,     â”‚
â”‚                            from_time, to_time, next_time, api_svr_url,   â”‚
â”‚                            is_init, **context)  â—€â”€â”€ ì—¬ê¸°                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. run_rename_cloud_files (file_renamer.py:388-419)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ def run_rename_cloud_files(...):                                         â”‚
â”‚     sources_info = get_sources_info(customer_code, source_type, ...)     â”‚
â”‚     for source_info in sources_info:                                     â”‚
â”‚         renamer = CloudFileRenamer(...)  â—€â”€â”€ ê°ì²´ ìƒì„±                   â”‚
â”‚         renamer.rename(crawl_history=crawl_history)  â—€â”€â”€ ë©”ì„œë“œ í˜¸ì¶œ     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. CloudFileRenamer.rename() (file_renamer.py:148-239)                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ def rename(self, crawl_history):                                         â”‚
â”‚     blobs = self.get_blobs()                                             â”‚
â”‚     file_id_mappings = self.get_file_id_mappings()  â—€â”€â”€ ğŸ”´ 12ë§Œê±´ ë¡œë“œ   â”‚
â”‚                                                                          â”‚
â”‚     for blob in blobs:                                                   â”‚
â”‚         file_name = blob.name.split("/")[-1]                             â”‚
â”‚         is_gen, file_id = self.get_file_id(file_id_mappings, file_name)  â”‚
â”‚         copy_blob(...)  # GCS ë³µì‚¬                                       â”‚
â”‚         if is_gen:                                                       â”‚
â”‚             self.post_file_id(file_id, file_name)  # Firestore INSERT    â”‚
â”‚         crawl_history.post_history(...)  # BigQuery INSERT               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. get_file_id_mappings() (file_renamer.py:105-115)  ğŸ”´ ë¬¸ì œ ì§€ì         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ def get_file_id_mappings(self):                                          â”‚
â”‚     get_file_ids_url = f"{api_svr_url}/file_id/{customer}/{source_id}"   â”‚
â”‚     res = get_request(endpoint=get_file_ids_url, ...)                    â”‚
â”‚     # â†‘ collect-manager APIê°€ Firestore 12ë§Œê±´ ì „ì²´ ë°˜í™˜                 â”‚
â”‚     # â†‘ ì—¬ê¸°ì„œ 500 ì—ëŸ¬ ë°œìƒ (ì‘ë‹µ í¬ê¸° ì´ˆê³¼)                            â”‚
â”‚     file_id_mappings = {data['id']: data['file_name'] for data in res}   â”‚
â”‚     return file_id_mappings                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### í˜¸ì¶œ ì²´ì¸ ìš”ì•½

| ë‹¨ê³„ | íŒŒì¼ | í•¨ìˆ˜/í´ë˜ìŠ¤ | ì‹¤í–‰ ìœ„ì¹˜ |
|------|------|-------------|-----------|
| 1 | c8cd3500.py | DAG ì •ì˜ | Airflow Scheduler |
| 2 | task_factory.py | `create_fileid_mapping_task` | Airflow Scheduler |
| 3 | task_functions.py | `crawl_rename_files` | **Airflow Worker** |
| 4 | file_renamer.py | `run_rename_cloud_files` | Airflow Worker |
| 5 | file_renamer.py | `CloudFileRenamer.rename` | Airflow Worker |
| 6 | file_renamer.py | `get_file_id_mappings` | Airflow Worker â†’ API í˜¸ì¶œ |

#### ì£¼ìš” íŠ¹ì§•

- **Cloud Function ì•„ë‹˜**: file_renamerëŠ” Airflow Workerì—ì„œ ì§ì ‘ ì‹¤í–‰ë¨
- **API í˜¸ì¶œ**: collect-manager APIë¥¼ í†µí•´ Firestore ë°ì´í„° ì¡°íšŒ
- **ë³‘ëª© ì§€ì **: `get_file_id_mappings()`ì—ì„œ ì „ì²´ ë§¤í•‘ ë¡œë“œ

### ë°°í¬ ê²½ë¡œ

file_renamer.pyëŠ” ë‘ ê°€ì§€ ê²½ë¡œë¡œ ì‹¤í–‰ë¨:

#### 1. Cloud Composer (ì¼ìƒ ìˆ˜ì§‘)

- DAG â†’ TaskFactory â†’ task_functions.py â†’ file_renamer.py
- Airflow Workerì—ì„œ ì§ì ‘ ì‹¤í–‰
- ë°°í¬: Composer íŒ¨í‚¤ì§€ ì—…ë°ì´íŠ¸

#### 2. Cloud Run Job: init-collector (ì´ˆê¸° ì ì¬)

ì´ˆê¸° ë°ì´í„° ì ì¬ìš© Cloud Run Job. HTTP ìš”ì²­ì„ ë°›ì•„ ìˆ˜ì§‘ íŒŒì´í”„ë¼ì¸ ì‹¤í–‰.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Cloud Run Job: init-collector                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  main.py (ì—”íŠ¸ë¦¬í¬ì¸íŠ¸)                                                 â”‚
â”‚  â”œâ”€â”€ run_init_collect(request)         â—€â”€â”€ HTTP POST ìš”ì²­ ìˆ˜ì‹           â”‚
â”‚  â”‚   â””â”€â”€ INITCollector(...).collect_main()                             â”‚
â”‚  â”‚                                                                      â”‚
â”‚  init_collector.py                                                      â”‚
â”‚  â”œâ”€â”€ class INITCollector                                                â”‚
â”‚  â”‚   â””â”€â”€ _collect_do()                                                  â”‚
â”‚  â”‚       â””â”€â”€ function_by_step = {                                       â”‚
â”‚  â”‚             TASK_CRAWL: run_rename_cloud_files(...)  â—€â”€â”€ ì—¬ê¸°!       â”‚
â”‚  â”‚             TASK_FILTER: run_clone_cloud_files(...)                  â”‚
â”‚  â”‚             TASK_CONVERT: run_gcs_file_converters(...)               â”‚
â”‚  â”‚             ...                                                      â”‚
â”‚  â”‚           }                                                          â”‚
â”‚  â”‚                                                                      â”‚
â”‚  collector/cloud/file_renamer.py  â—€â”€â”€ ë³µì‚¬ë˜ì–´ í¬í•¨ë¨                   â”‚
â”‚  collector/common/util.py         â—€â”€â”€ ë³µì‚¬ë˜ì–´ í¬í•¨ë¨                   â”‚
â”‚  collector/...                                                          â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ë°°í¬ êµ¬ì¡°:**

```
collector/deploy/run_init_collector/
â”œâ”€â”€ main.py              # ì—”íŠ¸ë¦¬í¬ì¸íŠ¸ (HTTP ìš”ì²­ ì²˜ë¦¬)
â”œâ”€â”€ init_collector.py    # INITCollector í´ë˜ìŠ¤
â”œâ”€â”€ deploy.sh            # ë°°í¬ ìŠ¤í¬ë¦½íŠ¸
â”œâ”€â”€ deploy_deps.list     # ë³µì‚¬í•  ì˜ì¡´ì„± ëª©ë¡
â””â”€â”€ requirements.txt

deploy_deps.list ë‚´ìš©:
â”œâ”€â”€ collector/cloud      â—€â”€â”€ file_renamer.py í¬í•¨!
â”œâ”€â”€ collector/common     â—€â”€â”€ util.py í¬í•¨!
â”œâ”€â”€ collector/excel
â”œâ”€â”€ collector/scripts
â”œâ”€â”€ collector/tag_preprocessing
â””â”€â”€ ...
```

**ë°°í¬ íë¦„:**

```bash
# deploy.sh ì‹¤í–‰ ì‹œ:
1. deploy_deps.list íŒŒì¼ ì½ìŒ
2. git archiveë¡œ í•´ë‹¹ íŒŒì¼ë“¤ì„ tmpdirì— ë³µì‚¬
3. gcloud functions deploy --gen2 ë¡œ ë°°í¬ (Cloud Run ê¸°ë°˜)
```

### ë°°í¬ ì‹œ ê³ ë ¤ì‚¬í•­

| ì»´í¬ë„ŒíŠ¸ | file_renamer.py ì‚¬ìš© ë°©ì‹ | ì¬ë°°í¬ ë°©ë²• |
|----------|---------------------------|-------------|
| Cloud Composer | import (íŒ¨í‚¤ì§€) | GCS ë²„í‚·ì— íŒŒì¼ ì—…ë¡œë“œ |
| init-collector | ë³µì‚¬ë¨ (deploy_deps.list) | `deploy.sh` ì‹¤í–‰ ë˜ëŠ” ì½˜ì†” ì¬ë°°í¬ |
| hai-renamer-service | **ë³„ë„ ì½”ë“œë² ì´ìŠ¤** | `deploy.sh` ì‹¤í–‰ (Cloud Run) |

### ìˆ˜ì • í•„ìš” íŒŒì¼ ëª©ë¡

**1. Composer (Airflow Workerì—ì„œ ì‹¤í–‰)**
```
collector/cloud/file_renamer.py      # CloudFileRenamer
collector/cloud/file_renamer_hai.py  # HaiFileRenamer (ìƒì†)
```

**2. init-collector (Cloud Run Job)**
```
collector/cloud/file_renamer.py      # deploy_deps.listë¡œ ë³µì‚¬ë¨
â†’ ì½”ë“œ ìˆ˜ì • ë¶ˆí•„ìš”, ì¬ë°°í¬ë§Œ í•˜ë©´ ë¨
```

**3. hai-renamer-service (Cloud Run Service) - ë³„ë„ ì½”ë“œë² ì´ìŠ¤**
```
hai_renamer_service/app/renamer/base_renamer.py      # CloudFileRenamer (ë³µì‚¬ë³¸)
hai_renamer_service/app/renamer/hai_file_renamer.py  # HaiFileRenamer (ë³µì‚¬ë³¸)
```

### ì•„í‚¤í…ì²˜ ê¸°ìˆ  ë¶€ì±„

```
âš ï¸ í˜„ì¬ ë¬¸ì œ: ë™ì¼ ë¡œì§ì´ 3ê³³ì— ì¤‘ë³µ
â”œâ”€â”€ collector/cloud/file_renamer*.py (Composerìš©)
â”œâ”€â”€ run_init_collector (collector/cloud ë³µì‚¬)
â””â”€â”€ hai_renamer_service (ì™„ì „ ë³„ë„ ì½”ë“œë² ì´ìŠ¤)

ğŸ“Œ TODO: hyperloungescripts-opt ì‘ì—… ì‹œ í†µí•© ì˜ˆì •
â”œâ”€â”€ ê³µí†µ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¡œ ë¶„ë¦¬
â””â”€â”€ ë˜ëŠ” ë‹¨ì¼ ì„œë¹„ìŠ¤ë¡œ í†µí•©
```

## ê°œì„ ì•ˆ: SHA256 ê¸°ë°˜ Deterministic file_id

### í•µì‹¬ ì•„ì´ë””ì–´

file_nameì—ì„œ file_idë¥¼ ê³„ì‚°í•˜ë©´, ê°™ì€ file_nameì€ í•­ìƒ ê°™ì€ file_idê°€ ë‚˜ì˜´.
â†’ "ì´ë¯¸ ë§Œë“  ì  ìˆë‚˜?" ì¡°íšŒ ìì²´ê°€ ë¶ˆí•„ìš”í•´ì§.

### ë³€ê²½ ë‚´ìš©

```python
# Before (UUID - ëœë¤)
import uuid
def generate_id12(prefix):
    return re.sub("-", "", prefix + str(uuid4())[:12])

# After (SHA256 - file_name ê¸°ë°˜)
import hashlib
def generate_file_id(file_name):
    hash_val = hashlib.sha256(file_name.encode()).hexdigest()[:11]
    return "f" + hash_val
```

### ë¹„êµ

```
file_name = "ë§¤ì¶œë³´ê³ ì„œ_20260203.xlsx"

UUID ë°©ì‹ (í˜„ì¬):
  1íšŒì°¨ ì‹¤í–‰: f1a2b3c4d5e6  â† ëœë¤
  2íšŒì°¨ ì‹¤í–‰: f9x8y7z6w5v4  â† ë˜ ëœë¤ (ë‹¤ë¥¸ ê°’)
  â†’ Firestore ì „ì²´ ì¡°íšŒ í•„ìˆ˜ ("ì´ì „ì— ë§Œë“  ì  ìˆë‚˜?")

SHA256 ë°©ì‹ (ë³€ê²½):
  1íšŒì°¨ ì‹¤í–‰: f7f3a8b2c1d0  â† file_nameìœ¼ë¡œ ê³„ì‚°
  2íšŒì°¨ ì‹¤í–‰: f7f3a8b2c1d0  â† ê°™ì€ file_name â†’ ê°™ì€ ê°’
  â†’ ì¡°íšŒ ë¶ˆí•„ìš”
```

### í¬ë§·

```
ë³€ê²½ ì—†ìŒ: f(1ì) + ë¬¸ì(11ì) = ì´ 12ì

UUID:   f + uuid4()[:11]              â†’ f1a2b3c4d5e (16ì§„ìˆ˜ 0-9, a-f)
SHA256: f + sha256(file_name)[:11]    â†’ f7f3a8b2c1d (16ì§„ìˆ˜ 0-9, a-f)

â€» ë‘˜ ë‹¤ ë™ì¼í•œ 16ì§„ìˆ˜ ë¬¸ì ë²”ìœ„ ì‚¬ìš© â†’ í¬ë§· í˜¸í™˜ì„± ë¬¸ì œ ì—†ìŒ
```

## ë³€ê²½ í›„ íë¦„

```
Before:
1. GET /file_id/{customer}/{source}   â† 12ë§Œê±´ ë¡œë“œ (ì—¬ê¸°ì„œ í„°ì§)
2. forë¬¸ ìˆœíšŒ ê²€ìƒ‰
3. ì—†ìœ¼ë©´ UUID ìƒì„±
4. GCS ë³µì‚¬
5. Firestore INSERT
6. BigQuery INSERT

After:
1. file_nameìœ¼ë¡œ file_id ê³„ì‚°        â† ì¡°íšŒ ì—†ìŒ
2. GCS ë³µì‚¬
3. Firestore UPSERT                  â† ìˆìœ¼ë©´ ë®ì–´ì“°ê¸°
4. BigQuery INSERT
```

## ì˜í–¥ ë²”ìœ„

### ìˆ˜ì • ëŒ€ìƒ
- `collector/cloud/file_renamer.py` â€” file_id ìƒì„± ë¡œì§ ë³€ê²½, ì „ì²´ ë§¤í•‘ ì¡°íšŒ ì œê±°
- `collector/common/util.py` â€” generate_id12 í•¨ìˆ˜ ë˜ëŠ” ì‹ ê·œ í•¨ìˆ˜ ì¶”ê°€

### í™•ì¸ í•„ìš”
- í•˜ìœ„ íŒŒì´í”„ë¼ì¸(filter, converter, tagger)ì—ì„œ file_id í¬ë§·ì— ì˜ì¡´í•˜ëŠ” ë¶€ë¶„ì´ ìˆëŠ”ì§€
  - file_idëŠ” GCS ê²½ë¡œì™€ BigQuery ê¸°ë¡ì— ì‚¬ìš©ë¨
  - í¬ë§·(f + 11ì)ì€ ë™ì¼í•˜ë¯€ë¡œ ë¬¸ì œ ì—†ì„ ê°€ëŠ¥ì„± ë†’ìŒ
  - UUIDì™€ SHA256 ëª¨ë‘ ë™ì¼í•œ 16ì§„ìˆ˜(0-9, a-f) ì‚¬ìš© â†’ ì •ê·œì‹ í˜¸í™˜ì„± ë¬¸ì œ ì—†ìŒ

### ê¸°ì¡´ ë°ì´í„°
- ì´ë¯¸ ìƒì„±ëœ file_id(UUID ê¸°ë°˜)ëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€
- ìƒˆë¡œ ìˆ˜ì§‘ë˜ëŠ” íŒŒì¼ë¶€í„° SHA256 ë°©ì‹ ì ìš©
- ê³¼ê±° ë°ì´í„°ì™€ì˜ í˜¸í™˜ì„± ë¬¸ì œ ì—†ìŒ (file_idëŠ” ê° íŒŒì¼ì— ë…ë¦½ì )

## ê´€ë ¨ ì´ìŠˆ

- BigQuery crawl_job_history ì¤‘ë³µ ì ì¬ ì´ìŠˆëŠ” ë³„ê±´ (HAI Renamer ì´ìŠˆ)ìœ¼ë¡œ ë¶„ë¦¬
- file_id ë°©ì‹ ë³€ê²½ê³¼ history ì¤‘ë³µì€ ì„œë¡œ ë…ë¦½ì ì¸ ë¬¸ì œ

## ì„ì‹œ ì¡°ì¹˜ (2026-02-04 ì™„ë£Œ)

- Firestoreì—ì„œ 2025-08 ~ 2025-11 ë°ì´í„° 77,936ê±´ ì‚­ì œ
- 12ë§Œê±´ â†’ 4.2ë§Œê±´ìœ¼ë¡œ ì¶•ì†Œ
- íƒœìŠ¤í¬ ì¬ì‹¤í–‰ ê°€ëŠ¥í•œ ìƒíƒœ

## ì ì§„ì  ì ìš© ì „ëµ

### ì™œ ì ì§„ì  ì ìš©ì¸ê°€?

| ì „ì²´ ì ìš© | ì ì§„ì  ì ìš© |
|-----------|-------------|
| ì½”ë“œ ë‹¨ìˆœ | ì½”ë“œì— ë¶„ê¸° ì¶”ê°€ í•„ìš” |
| ë¬¸ì œ ì‹œ ì „ì²´ ì˜í–¥ | ë¬¸ì œ ì‹œ íŠ¹ì • ê³ ê°ì‚¬ë§Œ ì˜í–¥ |
| ë¡¤ë°± ì‹œ ì „ì²´ ì›ë³µ | ë¡¤ë°± ì‹œ í•´ë‹¹ ê³ ê°ì‚¬ë§Œ ì›ë³µ |
| í•œ ë²ˆì— ê²€ì¦ í•„ìš” | ì‹¤ í™˜ê²½ì—ì„œ ë‹¨ê³„ì  ê²€ì¦ ê°€ëŠ¥ |

**ê²°ë¡ **: ë¦¬ìŠ¤í¬ ìµœì†Œí™”ë¥¼ ìœ„í•´ ì ì§„ì  ì ìš© ì„ íƒ

### êµ¬í˜„ ë°©ì‹

```python
# file_renamer.py

# SHA256 ë°©ì‹ ì ìš© ê³ ê°ì‚¬ ëª©ë¡
SHA256_ENABLED_CUSTOMERS = [
    'c8cd3500',  # ì—˜ì•¤ì¼€ì´ì›°ë‹ˆìŠ¤ (ë¬¸ì œ ë°œìƒ ê³ ê°ì‚¬, 1ë‹¨ê³„)
]

class CloudFileRenamer:
    def get_file_id(self, file_id_mappings, file_name):
        if self.customer_code in SHA256_ENABLED_CUSTOMERS:
            # ìƒˆ ë°©ì‹: SHA256 ê¸°ë°˜ (Firestore ì¡°íšŒ ë¶ˆí•„ìš”)
            return self._get_file_id_sha256(file_name)
        else:
            # ê¸°ì¡´ ë°©ì‹: UUID + Firestore ì „ì²´ ì¡°íšŒ
            return self._get_file_id_legacy(file_id_mappings, file_name)

    def _get_file_id_sha256(self, file_name):
        """SHA256 ê¸°ë°˜ ê²°ì •ë¡ ì  file_id ìƒì„±"""
        hash_val = hashlib.sha256(file_name.encode()).hexdigest()[:11]
        file_id = "f" + hash_val
        return True, file_id  # í•­ìƒ ìƒˆë¡œ ìƒì„±ëœ ê²ƒìœ¼ë¡œ ì²˜ë¦¬ (UPSERT)

    def _get_file_id_legacy(self, file_id_mappings, file_name):
        """ê¸°ì¡´ UUID ë°©ì‹ (Firestore ì¡°íšŒ í•„ìš”)"""
        for _file_id, _file_name in file_id_mappings.items():
            if file_name == _file_name:
                return False, _file_id

        while True:
            gen_file_id = generate_id12(prefix=self.file_prefix)
            if gen_file_id not in file_id_mappings.keys():
                return True, gen_file_id

    def rename(self, crawl_history):
        blobs = self.get_blobs()

        # SHA256 ê³ ê°ì‚¬ëŠ” Firestore ì¡°íšŒ ìŠ¤í‚µ
        if self.customer_code in SHA256_ENABLED_CUSTOMERS:
            file_id_mappings = {}  # ë¹ˆ dict (ì‚¬ìš© ì•ˆ í•¨)
        else:
            file_id_mappings = self.get_file_id_mappings()  # ê¸°ì¡´ ë°©ì‹

        for blob in blobs:
            # ... ê¸°ì¡´ ë¡œì§
```

### ë¡¤ì•„ì›ƒ ê³„íš

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1ë‹¨ê³„: c8cd3500 (ì—˜ì•¤ì¼€ì´ì›°ë‹ˆìŠ¤)                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ - ë¬¸ì œ ë°œìƒí•œ ê³ ê°ì‚¬                                                 â”‚
â”‚ - board ì†ŒìŠ¤ 12ë§Œê±´ â†’ SHA256 ì ìš©                                   â”‚
â”‚ - 1ì£¼ì¼ ëª¨ë‹ˆí„°ë§                                                     â”‚
â”‚ - í™•ì¸: GCS íŒŒì¼ ì •ìƒ, BigQuery ê¸°ë¡ ì •ìƒ, í•˜ìœ„ íŒŒì´í”„ë¼ì¸ ì •ìƒ      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2ë‹¨ê³„: ì†Œê·œëª¨ ê³ ê°ì‚¬ 2-3ê°œ ì¶”ê°€                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ - ë°ì´í„° ì ì€ ê³ ê°ì‚¬ ì„ ì •                                            â”‚
â”‚ - 1ì£¼ì¼ ëª¨ë‹ˆí„°ë§                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3ë‹¨ê³„: ì „ì²´ ì ìš©                                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ - SHA256_ENABLED_CUSTOMERS ë¦¬ìŠ¤íŠ¸ ì œê±°                               â”‚
â”‚ - ëª¨ë“  ê³ ê°ì‚¬ SHA256 ë°©ì‹ìœ¼ë¡œ í†µì¼                                   â”‚
â”‚ - ë ˆê±°ì‹œ ì½”ë“œ ì •ë¦¬                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ëª¨ë‹ˆí„°ë§ ì²´í¬ë¦¬ìŠ¤íŠ¸

1ë‹¨ê³„ ì ìš© í›„ í™•ì¸ ì‚¬í•­:

- [ ] `fileid-mapping-board` íƒœìŠ¤í¬ ì„±ê³µ ì—¬ë¶€
- [ ] GCSì— file_idë¡œ íŒŒì¼ ì •ìƒ ë³µì‚¬ í™•ì¸
- [ ] Firestoreì— ìƒˆ file_id ë§¤í•‘ ì €ì¥ í™•ì¸
- [ ] BigQuery crawl_job_history ì •ìƒ ê¸°ë¡ í™•ì¸
- [ ] filter â†’ converter â†’ tagger íŒŒì´í”„ë¼ì¸ ì •ìƒ ë™ì‘
- [ ] ê°™ì€ íŒŒì¼ retry ì‹œ ë™ì¼ file_id ìƒì„± í™•ì¸

### ë¡¤ë°± ë°©ë²•

ë¬¸ì œ ë°œìƒ ì‹œ:

```python
# í•´ë‹¹ ê³ ê°ì‚¬ë¥¼ ë¦¬ìŠ¤íŠ¸ì—ì„œ ì œê±°
SHA256_ENABLED_CUSTOMERS = [
    # 'c8cd3500',  # ì£¼ì„ ì²˜ë¦¬ë¡œ ë¡¤ë°±
]
```

ì¬ë°°í¬ í›„ ê¸°ì¡´ UUID ë°©ì‹ìœ¼ë¡œ ìë™ ë³µê·€

## í…ŒìŠ¤íŠ¸ ê²°ê³¼ (2026-02-10)

### 1ë‹¨ê³„ í…ŒìŠ¤íŠ¸: c8cd3500 (ì—˜ì•¤ì¼€ì´ì›°ë‹ˆìŠ¤)

**í…ŒìŠ¤íŠ¸ í™˜ê²½:**
- DAG: `c8cd3500-20240517-1`
- ì†ŒìŠ¤: board (s4da50eb)
- ingestion_id: 20260208140000

**ê²°ê³¼ ë¹„êµ:**

| í•­ëª© | ê¸°ì¡´ (attempt 1) | SHA256 (attempt 2) |
|------|------------------|-------------------|
| Firestore ì¡°íšŒ | 27ì´ˆ ì†Œìš” | **ìŠ¤í‚µ (0ì´ˆ)** |
| ë¡œê·¸ | `generate file_id=...` | `[SHA256] generate file_id=...` |
| file_id ì˜ˆì‹œ | `f4ed76cc945b` (UUID) | `fa9920109881` (SHA256) |

**ë¡œê·¸ í™•ì¸:**
```
# ê¸°ì¡´ ë°©ì‹ (27ì´ˆ Firestore ì¡°íšŒ)
[19:50:09] get_request: .../file_id/c8cd3500/s4da50eb
[19:50:36] [200 - OK]  â† 27ì´ˆ!
[19:50:36] generate file_id=f4ed76cc945b

# SHA256 ë°©ì‹ (ì¡°íšŒ ìŠ¤í‚µ)
[05:29:20] [SHA256] Skip Firestore lookup for customer=c8cd3500
[05:29:20] [SHA256] generate file_id=fa9920109881  â† ì¦‰ì‹œ!
```

**í•˜ìœ„ íŒŒì´í”„ë¼ì¸ ê²€ì¦:**

| ë‹¨ê³„ | ìƒíƒœ | ë¹„ê³  |
|------|------|------|
| crawl (file_renamer) | âœ… ì„±ê³µ | SHA256 file_id ìƒì„± |
| filter | âœ… ì„±ê³µ | file_id ì •ìƒ ì²˜ë¦¬ |
| convert | âœ… ì„±ê³µ | cvt_meta_ids ì •ìƒ ìƒì„± |

**ê²°ë¡ :**
- âœ… Firestore 12ë§Œê±´ ì¡°íšŒ ë¬¸ì œ í•´ê²°
- âœ… í•˜ìœ„ íŒŒì´í”„ë¼ì¸ í˜¸í™˜ì„± í™•ì¸
- âœ… file_id í¬ë§· (f + 11ìë¦¬ 16ì§„ìˆ˜) ìœ ì§€

---

## ë°°í¬ ì²´í¬ë¦¬ìŠ¤íŠ¸

ì½”ë“œ ë³€ê²½ í›„ ì¬ë°°í¬ê°€ í•„ìš”í•œ ì„œë¹„ìŠ¤ ëª©ë¡.

### 1. init-collector (Cloud Run Job)

**ì—­í• :** ì´ˆê¸° ë°ì´í„° ì ì¬ìš© ë°°ì¹˜ ì‘ì—…

**ì†ŒìŠ¤ ê²½ë¡œ:**
```
collector/deploy/run_init_collector_job/
â”œâ”€â”€ build_docker.sh      # ë°°í¬ ìŠ¤í¬ë¦½íŠ¸
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ main.py
â”œâ”€â”€ app_deps.list        # ë³µì‚¬í•  ì˜ì¡´ì„± ëª©ë¡
â””â”€â”€ make_app_deps.sh     # ì˜ì¡´ì„± ë³µì‚¬ ìŠ¤í¬ë¦½íŠ¸
```

**ë°°í¬ ëª…ë ¹:**
```bash
cd collector/deploy/run_init_collector_job
bash build_docker.sh
```

**ê²°ê³¼:**
- ì´ë¯¸ì§€: `asia-northeast3-docker.pkg.dev/hyperlounge-dev/cloud-run-job/init-collector:latest`
- Cloud Run Jobì´ ìë™ìœ¼ë¡œ ìƒˆ ì´ë¯¸ì§€ ì‚¬ìš©

**ì˜í–¥ ë°›ëŠ” ì½”ë“œ:**
- `collector/cloud/file_renamer.py`
- `collector/cloud/file_renamer_hai.py`
- `collector/common/util.py`
- ê¸°íƒ€ `app_deps.list`ì— í¬í•¨ëœ íŒŒì¼ë“¤

---

### 2. hai-renamer-service (Cloud Run Service)

**ì—­í• :** HAI ë°©ì‹ íŒŒì¼ ë¦¬ë„¤ì´ë° API ì„œë¹„ìŠ¤

**ì†ŒìŠ¤ ê²½ë¡œ:**
```
hai_renamer_service/
â”œâ”€â”€ deploy.sh            # ë°°í¬ ìŠ¤í¬ë¦½íŠ¸
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ app/
â”‚   â””â”€â”€ renamer/
â”‚       â”œâ”€â”€ base_renamer.py      # CloudFileRenamer (ë³„ë„ ë³µì‚¬ë³¸)
â”‚       â””â”€â”€ hai_file_renamer.py  # HaiFileRenamer (ë³„ë„ ë³µì‚¬ë³¸)
â””â”€â”€ requirements.txt
```

**ë°°í¬ ëª…ë ¹:**
```bash
cd hai_renamer_service
bash deploy.sh
```

**ê²°ê³¼:**
- URL: `https://hai-renamer-service-848582894134.asia-northeast3.run.app`

**âš ï¸ ì£¼ì˜:**
- `collector/cloud/file_renamer*.py`ì™€ ë³„ë„ ì½”ë“œë² ì´ìŠ¤
- ì–‘ìª½ ëª¨ë‘ ìˆ˜ì • í•„ìš”í•  ìˆ˜ ìˆìŒ

---

### 3. run-init-collect-1-0 (Cloud Function Gen2)

**ì—­í• :** HTTP íŠ¸ë¦¬ê±°ë¡œ ìˆ˜ì§‘ íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ (init-collectorì™€ ìœ ì‚¬í•˜ì§€ë§Œ Cloud Function)

**ì†ŒìŠ¤ ê²½ë¡œ:**
```
collector/deploy/run_init_collector/
â”œâ”€â”€ deploy.sh            # ë°°í¬ ìŠ¤í¬ë¦½íŠ¸
â”œâ”€â”€ main.py
â”œâ”€â”€ init_collector.py
â”œâ”€â”€ deploy_deps.list     # ë³µì‚¬í•  ì˜ì¡´ì„± ëª©ë¡
â””â”€â”€ requirements.txt
```

**ë°°í¬ ëª…ë ¹:**
```bash
cd collector/deploy/run_init_collector
bash deploy.sh
```

**ê²°ê³¼:**
- Cloud Function: `run-init-collect-1-0`
- Gen2 (Cloud Run ê¸°ë°˜)

---

### 4. Cloud Composer (Airflow)

**ì—­í• :** ì¼ìƒ ìˆ˜ì§‘ DAG ì‹¤í–‰

**ì˜í–¥ ë°›ëŠ” íŒŒì¼:**
```
collector/cloud/file_renamer.py
collector/cloud/file_renamer_hai.py
collector/common/util.py
```

**ë°°í¬ ë°©ë²•:**
- Composer íŒ¨í‚¤ì§€ ì—…ë°ì´íŠ¸ (ë³„ë„ í”„ë¡œì„¸ìŠ¤)
- ë˜ëŠ” GCS ë²„í‚·ì— íŒŒì¼ ì—…ë¡œë“œ

---

### ë°°í¬ ìˆœì„œ ê¶Œì¥

ì½”ë“œ ìˆ˜ì • í›„ ë‹¤ìŒ ìˆœì„œë¡œ ë°°í¬:

```
1. hai-renamer-service     â† ë³„ë„ ì½”ë“œë² ì´ìŠ¤ì´ë¯€ë¡œ ë¨¼ì € ìˆ˜ì •/ë°°í¬
2. init-collector          â† Cloud Run Job
3. run-init-collect-1-0    â† Cloud Function (í•„ìš”ì‹œ)
4. Cloud Composer          â† ì¼ìƒ ìˆ˜ì§‘ìš©
```

### ë¹ ë¥¸ ë°°í¬ ëª…ë ¹ (ì „ì²´)

```bash
# 1. hai-renamer-service
cd /path/to/hyperloungescripts/hai_renamer_service && bash deploy.sh

# 2. init-collector (Cloud Run Job)
cd /path/to/hyperloungescripts/collector/deploy/run_init_collector_job && bash build_docker.sh

# 3. run-init-collect (Cloud Function, í•„ìš”ì‹œ)
cd /path/to/hyperloungescripts/collector/deploy/run_init_collector && bash deploy.sh
```

### ë§ˆì§€ë§‰ ë°°í¬ ê¸°ë¡

| ì„œë¹„ìŠ¤ | ë°°í¬ì¼ | ë²„ì „/ì»¤ë°‹ | ë¹„ê³  |
|--------|--------|-----------|------|
| init-collector | 2026-02-10 | master (0a01fa10) | SHA256 ì ìš©, pyarrow ë²„ì „ ìˆ˜ì • |
| hai-renamer-service | 2026-02-10 | master | SHA256 ì ìš© |
| run-init-collect-1-0 | 2026-02-10 | master | pyarrow==14.0.2 ìˆ˜ì • |

---

## ì§„í–‰ í˜„í™© ë° í–¥í›„ ê³„íš

### ì›ë³¸ Agenda

```
[Tech] file_id ë§¤í•‘ ì¡°íšŒ êµ¬ì¡° ê°œì„ 

ì¦ìƒ: c8cd3500 board ì†ŒìŠ¤ì—ì„œ 12ë§Œê±´ API ì‘ë‹µ í¬ê¸° ì´ˆê³¼ë¡œ 500 ì—ëŸ¬
ì›ì¸: file_id ìƒì„±ì´ UUID ëœë¤ ë°©ì‹ì´ë¼ ì¤‘ë³µ ì²´í¬ë¥¼ ìœ„í•´ ì „ì²´ ë§¤í•‘ ì¡°íšŒ í•„ìš”
í•´ê²°: SHA256 deterministic ID + Firestore upsert
```

### ì§„í–‰ í˜„í™© (2026-02-10 ê¸°ì¤€)

| ë‹¨ê³„ | ë‚´ìš© | ìƒíƒœ | ì™„ë£Œì¼ |
|------|------|------|--------|
| ì„ì‹œ ì¡°ì¹˜ | Firestore 77,936ê±´ ì‚­ì œ (12ë§Œâ†’4.2ë§Œ) | âœ… ì™„ë£Œ | 2026-02-04 |
| 1ë‹¨ê³„ | collect-manager upsert ì§€ì› í™•ì¸ | âœ… ì™„ë£Œ | 2026-02-06 |
| 2ë‹¨ê³„ | `generate_file_id(file_name)` í•¨ìˆ˜ êµ¬í˜„ | âœ… ì™„ë£Œ | 2026-02-08 |
| 3ë‹¨ê³„ | file_renamer.py SHA256 ë¶„ê¸° ì ìš© | âœ… ì™„ë£Œ | 2026-02-09 |
| 4ë‹¨ê³„ | hai_renamer_serviceì—ë„ SHA256 ì ìš© | âœ… ì™„ë£Œ | 2026-02-09 |
| 5ë‹¨ê³„ | c8cd3500 í…ŒìŠ¤íŠ¸ (1ë‹¨ê³„ ë¡¤ì•„ì›ƒ) | âœ… ì™„ë£Œ | 2026-02-10 |
| 6ë‹¨ê³„ | ì„œë¹„ìŠ¤ ì¬ë°°í¬ | âœ… ì™„ë£Œ | 2026-02-10 |

### ë°°í¬ ì™„ë£Œ ì„œë¹„ìŠ¤

| ì„œë¹„ìŠ¤ | íƒ€ì… | SHA256 ì ìš© | ë°°í¬ì¼ |
|--------|------|-------------|--------|
| init-collector | Cloud Run Job | âœ… | 2026-02-10 |
| hai-renamer-service | Cloud Run Service | âœ… | 2026-02-10 |
| run-init-collect-1-0 | Cloud Function Gen2 | âœ… | 2026-02-10 |
| Cloud Composer | Airflow | â³ ë¯¸ë°°í¬ | - |

### í˜„ì¬ SHA256 ì ìš© ê³ ê°ì‚¬

```python
# file_renamer.py, hai_file_renamer.py
SHA256_ENABLED_CUSTOMERS = [
    'c8cd3500',  # ì—˜ì•¤ì¼€ì´ì›°ë‹ˆìŠ¤ (1ë‹¨ê³„)
]
```

### í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½

- âœ… Firestore ì¡°íšŒ 27ì´ˆ â†’ 0ì´ˆ (ìŠ¤í‚µ)
- âœ… í•˜ìœ„ íŒŒì´í”„ë¼ì¸ (filter, convert, tag) ì •ìƒ ë™ì‘
- âœ… file_id í¬ë§· í˜¸í™˜ì„± ìœ ì§€ (f + 11ìë¦¬ hex)

---

### í–¥í›„ ê³„íš

#### 2ë‹¨ê³„: ì†Œê·œëª¨ ê³ ê°ì‚¬ ì¶”ê°€ (ì˜ˆì •)

```python
SHA256_ENABLED_CUSTOMERS = [
    'c8cd3500',  # ì—˜ì•¤ì¼€ì´ì›°ë‹ˆìŠ¤ (ì™„ë£Œ)
    'xxxxxxxx',  # ì†Œê·œëª¨ ê³ ê°ì‚¬ A (ì˜ˆì •)
    'yyyyyyyy',  # ì†Œê·œëª¨ ê³ ê°ì‚¬ B (ì˜ˆì •)
]
```

**ì„ ì • ê¸°ì¤€:**
- ë°ì´í„° ê±´ìˆ˜ ì ì€ ê³ ê°ì‚¬
- board ë˜ëŠ” shared_drive ì†ŒìŠ¤ ì‚¬ìš©
- ë¬¸ì œ ë°œìƒ ì‹œ ì˜í–¥ ìµœì†Œí™”

**ëª¨ë‹ˆí„°ë§ ê¸°ê°„:** 1ì£¼ì¼

#### 3ë‹¨ê³„: ì „ì²´ ì ìš©

```python
# SHA256_ENABLED_CUSTOMERS ë¦¬ìŠ¤íŠ¸ ì œê±°
# ëª¨ë“  ê³ ê°ì‚¬ SHA256 ë°©ì‹ìœ¼ë¡œ í†µì¼

class CloudFileRenamer:
    def get_file_id(self, file_name):
        # ë ˆê±°ì‹œ ë¶„ê¸° ì œê±°, SHA256ë§Œ ì‚¬ìš©
        return self._get_file_id_sha256(file_name)
```

**ì‘ì—… ë‚´ìš©:**
- [ ] ë¶„ê¸° ì½”ë“œ ì œê±°
- [ ] ë ˆê±°ì‹œ `_get_file_id_legacy()` í•¨ìˆ˜ ì‚­ì œ
- [ ] `get_file_id_mappings()` í˜¸ì¶œë¶€ ì‚­ì œ
- [ ] í…ŒìŠ¤íŠ¸ ë° ë°°í¬

#### 4ë‹¨ê³„: Cloud Composer ë°°í¬

**í˜„ì¬ ìƒíƒœ:** Cloud Run ì„œë¹„ìŠ¤ë“¤ë§Œ ë°°í¬ ì™„ë£Œ, ComposerëŠ” ë¯¸ë°˜ì˜

**í•„ìš” ì‘ì—…:**
- [ ] Composer íŒ¨í‚¤ì§€ ì—…ë°ì´íŠ¸ (ë³„ë„ í”„ë¡œì„¸ìŠ¤)
- [ ] ì¼ìƒ ìˆ˜ì§‘ DAGì—ì„œ SHA256 ë°©ì‹ ì‚¬ìš© í™•ì¸

#### 5ë‹¨ê³„: ê¸°ìˆ  ë¶€ì±„ ì •ë¦¬

```
í˜„ì¬ ë¬¸ì œ: ë™ì¼ ë¡œì§ì´ 3ê³³ì— ì¤‘ë³µ
â”œâ”€â”€ collector/cloud/file_renamer*.py (Composerìš©)
â”œâ”€â”€ run_init_collector_job (collector/cloud ë³µì‚¬)
â””â”€â”€ hai_renamer_service (ë³„ë„ ì½”ë“œë² ì´ìŠ¤)

TODO: hyperloungescripts-opt ì‘ì—… ì‹œ í†µí•© ì˜ˆì •
â”œâ”€â”€ ê³µí†µ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¡œ ë¶„ë¦¬
â””â”€â”€ ë˜ëŠ” ë‹¨ì¼ ì„œë¹„ìŠ¤ë¡œ í†µí•©
```

---

### ì²´í¬ë¦¬ìŠ¤íŠ¸

#### ì™„ë£Œ í•­ëª©
- [x] SHA256 ê¸°ë°˜ file_id ìƒì„± í•¨ìˆ˜ êµ¬í˜„
- [x] ì ì§„ì  ì ìš© ë¶„ê¸° ë¡œì§ ì¶”ê°€
- [x] c8cd3500 ê³ ê°ì‚¬ í…ŒìŠ¤íŠ¸
- [x] init-collector ì¬ë°°í¬
- [x] hai-renamer-service ì¬ë°°í¬
- [x] run-init-collect-1-0 ì¬ë°°í¬
- [x] ë°°í¬ ì²´í¬ë¦¬ìŠ¤íŠ¸ ë¬¸ì„œí™”

#### ì§„í–‰ ì˜ˆì •
- [ ] 2ë‹¨ê³„ ê³ ê°ì‚¬ ì„ ì • ë° ì ìš©
- [ ] 1ì£¼ì¼ ëª¨ë‹ˆí„°ë§
- [ ] 3ë‹¨ê³„ ì „ì²´ ì ìš©
- [ ] Cloud Composer ë°°í¬
- [ ] ë ˆê±°ì‹œ ì½”ë“œ ì •ë¦¬
